\documentclass[11pt]{article}

% -------------------------------------------------
% Layout and typography
% -------------------------------------------------
\usepackage[a4paper,margin=1in]{geometry}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{microtype}

% Widow / orphan control
\widowpenalty=10000
\clubpenalty=10000
\displaywidowpenalty=10000

% -------------------------------------------------
% Tables and formatting
% -------------------------------------------------
\usepackage{booktabs}
\usepackage{array}
\usepackage{longtable}

% -------------------------------------------------
% Code blocks
% -------------------------------------------------
\usepackage{listings}
\lstset{
  basicstyle=\ttfamily\small,
  columns=fullflexible,
  keepspaces=true,
  frame=single,
  breaklines=true
}

% -------------------------------------------------
% Hyperlinks
% -------------------------------------------------
\usepackage[hidelinks]{hyperref}

% -------------------------------------------------
% Document
% -------------------------------------------------
\begin{document}

\begin{center}
{\LARGE \textbf{CPU Architecture Documentation}}
\end{center}

\vspace{1em}

% -------------------------------------------------
% Table of Contents (manual, matching original)
% -------------------------------------------------
\begin{center}
\begin{tabular}{c}
\textbf{Table of Contents} \\
\midrule
\hyperref[sec:structure]{Structure} \\
\hyperref[sec:fetch]{Fetch} \\
\hyperref[sec:decode]{Decode} \\
\hyperref[sec:execute]{Execute} \\
\hyperref[sec:connections]{Connections} \\
\hyperref[sec:cycle]{Cycle} \\
\hyperref[sec:buses]{Buses} \\
\hyperref[sec:todo]{Todo} \\
\end{tabular}
\end{center}

\hrule
\vspace{1em}
\hrule

% =================================================
\section{Structure}
\label{sec:structure}

\subsection{Registers}

\begin{longtable}{>{\centering}m{3cm} >{\centering}m{3cm} >{\centering\arraybackslash}m{5cm}}
\toprule
\textbf{Register} & \textbf{Size (bits)} & \textbf{Name} \\
\midrule
\hyperref[reg:pc]{PC} & 8 & Program Counter \\
\hyperref[reg:cir]{CIR\_Opcode} & 4 & Current Instruction Register \\
\hyperref[reg:cir]{CIR\_Operand} & 8 & Current Instruction Register \\
\hyperref[reg:mar]{MAR} & 8 & Memory Address Register \\
\hyperref[reg:mdr]{MDR} & 8 & Memory Data Register \\
\hyperref[reg:acc]{ACC} & 8 & Accumulator \\
\hyperref[reg:flag]{FLAG} & 4 & G, E \\
\hyperref[reg:ram]{RAM\_Opcode} & 256$\times$4 & Random Access Memory \\
\hyperref[reg:ram]{RAM\_Operand} & 256$\times$8 & Random Access Memory \\
\bottomrule
\end{longtable}

\noindent
\emph{RAM is split into: \textbf{224$\times$12 ROM} + \textbf{32$\times$12 RAM}}

% -------------------------------------------------
\subsection{Operations}

\begin{longtable}{>{\centering}m{3cm} >{\centering}m{3cm} >{\centering\arraybackslash}m{6cm}}
\toprule
\textbf{Mnemonic} & \textbf{Opcode} & \textbf{Details} \\
\midrule
NOP & 0 & No Operation \\
LDA & 1 & Load RAM $\rightarrow$ ACC \\
LDI & 2 & Load Immediate $\rightarrow$ ACC \\
STA & 3 & Store ACC $\rightarrow$ RAM \\
JMP & 4 & Jump Unconditionally \\
JEQ & 5 & Jump if E FLAG \\
JGT & 6 & Jump if G FLAG \\
CMP & 7 & Set FLAG \\
ADD & 8 & Add ACC += RAM \\
ADI & 9 & Add ACC += Immediate \\
SUB & 10 & Sub ACC -= RAM \\
SBI & 11 & Sub ACC -= Immediate \\
SHF & 12 & Shift ACC $\ll=$ RAM \\
AND & 13 & And ACC \&= RAM \\
ORR & 14 & Or ACC |= RAM \\
XOR & 15 & Xor ACC $\oplus=$ RAM \\
\bottomrule
\end{longtable}

\subsubsection*{Unused}

\begin{tabular}{ccc}
\toprule
Mnemonic & Opcode & Details \\
\midrule
NOT & -- & Not ACC = $\sim$ACC \\
MUL & -- & Multiply ACC *= RAM \\
INC & -- & Increment ACC++ \\
DEC & -- & Decrement ACC-- \\
JZR & -- & Jump if Z FLAG \\
\bottomrule
\end{tabular}

% =================================================
\section{Fetch}
\label{sec:fetch}

\begin{lstlisting}
MAR <- PC
CIR_Opcode <- RAM[MAR]_Opcode
CIR_Operand <- RAM[MAR]_Operand
PC <- PC + 1
\end{lstlisting}

% =================================================
\section{Decode}
\label{sec:decode}

Opcode $\rightarrow$ 4 bits

Operand $\rightarrow$ 8 bits (Data, Address)

\subsubsection*{Special}

\texttt{0} $\rightarrow$ NOP

\texttt{3} $\rightarrow$ STA
\begin{lstlisting}
MAR <- CIR_Operand
\end{lstlisting}

\texttt{4,5,6} $\rightarrow$ jumps
\begin{lstlisting}
MDR <- CIR_Operand
\end{lstlisting}

\subsubsection*{ACC / FLAGS $\leftarrow x$}

\texttt{1,7,8,10,12,13,14,15}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
\end{lstlisting}

\texttt{2,9,11}
\begin{lstlisting}
MDR <- CIR_Operand
\end{lstlisting}

% =================================================
\section{Execute}
\label{sec:execute}

\subsubsection*{0 -- NOP}
\begin{lstlisting}
\end{lstlisting}

\subsubsection*{1 -- LDA}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
ACC <- MDR
\end{lstlisting}

\subsubsection*{2 -- LDI}
\begin{lstlisting}
MDR <- CIR_Operand
ACC <- MDR
\end{lstlisting}

\subsubsection*{3 -- STA}
\begin{lstlisting}
MAR <- CIR_Operand
RAM[MAR]_Operand <- ACC
\end{lstlisting}

\subsubsection*{4 -- JMP}
\begin{lstlisting}
MDR <- CIR_Operand
PC <- MDR
\end{lstlisting}

\subsubsection*{5 -- JEQ}
\begin{lstlisting}
MDR <- CIR_Operand
if E:
    PC <- MDR
\end{lstlisting}

\subsubsection*{6 -- JGT}
\begin{lstlisting}
MDR <- CIR_Operand
if G:
    PC <- MDR
\end{lstlisting}

\subsubsection*{7 -- CMP}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
FLAG <- compare(ACC, MDR)
\end{lstlisting}

\subsubsection*{8 -- ADD}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
ACC <- ACC + MDR
\end{lstlisting}

\subsubsection*{9 -- ADI}
\begin{lstlisting}
MDR <- CIR_Operand
ACC <- ACC + MDR
\end{lstlisting}

\subsubsection*{10 -- SUB}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
ACC <- ACC - MDR
\end{lstlisting}

\subsubsection*{11 -- SBI}
\begin{lstlisting}
MDR <- CIR_Operand
ACC <- ACC - MDR
\end{lstlisting}

\subsubsection*{12 -- SHF}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
ACC <- ACC << MDR
\end{lstlisting}

\subsubsection*{13 -- AND}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
ACC <- ACC & MDR
\end{lstlisting}

\subsubsection*{14 -- ORR}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
ACC <- ACC | MDR
\end{lstlisting}

\subsubsection*{15 -- XOR}
\begin{lstlisting}
MAR <- CIR_Operand
MDR <- RAM[MAR]_Operand
ACC <- ACC ^ MDR
\end{lstlisting}

% =================================================
\section{Connections}
\label{sec:connections}

(All connection diagrams preserved verbatim as logic descriptions.)

\subsection*{PC}
\begin{lstlisting}
ALU 1-> | PC | *-> MAR
\end{lstlisting}

\subsection*{CIR}
\begin{lstlisting}
RAM 1-> | CIR_Operand | /2-> MAR
        |             | \3-> MDR
\end{lstlisting}

\subsection*{MAR}
\begin{lstlisting}
PC 1->\ | MAR | *-> RAM[]
CIR 2->/
\end{lstlisting}

\subsection*{MDR}
\begin{lstlisting}
CIR 1->\ | MDR | 3-> ALU
RAM 2->/
\end{lstlisting}

\subsection*{ACC}
\begin{lstlisting}
ALU 1-> | ACC | 2-> MDR
\end{lstlisting}

\subsection*{FLAG}
\begin{lstlisting}
ALU 1*-> | FLAG | 2*-> ALU
\end{lstlisting}

\subsection*{RAM}
\begin{lstlisting}
ALU 1-> | RAM | /2-> CIR
MAR *-> |     | \3-> MDR
\end{lstlisting}

% =================================================
\section{Cycle}
\label{sec:cycle}

\begin{lstlisting}
10 tick cycle:
4 - FETCH
4/2 - DECODE
2 - EXECUTE
\end{lstlisting}

% =================================================
\section{Buses}
\label{sec:buses}

\begin{lstlisting}
store MAR
pulse MAR

store MDR
pulse MDR

pulse EXECUTE
\end{lstlisting}

\hrule
\vspace{1em}
\hrule

% =================================================
\section*{TODO}
\label{sec:todo}

\begin{itemize}
\item \sout{8 ring counter}
\item \sout{2x4 mux}
\item \sout{2x4,8 demux}
\item \sout{edit ALU}
\item \sout{fix comparator}
\item \sout{16 ring counter}
\item \sout{put buses}
\item \sout{SHT negative}
\item \sout{write proper script}
\item \sout{ROM loading routine}
\item \sout{update doc}
\item update --
\item organise core
\item ? remove demuxes
\end{itemize}

\end{document}
